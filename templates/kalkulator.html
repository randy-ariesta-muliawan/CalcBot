<!DOCTYPE html>
<html lang="id">
<head>
    <!-- Set character encoding and responsive viewport -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CalcBot</title>

    <!-- MathJax config: atur delimiters dan perilaku pemrosesan -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['\\(','\\)']], // delimiter inline
          displayMath: [['\\[','\\]']], // delimiter display
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          skipHtmlTags: ['script','noscript','style','textarea','pre','code'] // jangan proses tag ini
        }
      };
    </script>
    <!-- Muat MathJax dari CDN untuk merender LaTeX -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Muat TailwindCSS dan ikon -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='favicon/site.webmanifest') }}">

    <style>
        /* Styling umum halaman */
        body { font-family: 'Inter', sans-serif; background:#fef3c7; }
        .tab-content { animation: fadeIn .28s ease-in-out; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(8px);} to {opacity:1; transform:translateY(0);} }
        .loading-animation { border-top-color: transparent; border-radius:50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Konten LaTeX dan penjelasan */
        .latex-content { line-height: 2.2; overflow-x: auto; }
        .explanation-text { white-space: pre-wrap; word-wrap: break-word; font-size: 1.02rem; line-height: 1.9; color: #0f172a; background: linear-gradient(180deg, rgba(239,246,255,0.6), rgba(255,255,255,0.4)); padding: 0.75rem; border-radius: 0.75rem; }
        .explanation-text p { margin: 0 0 1rem 0; }
        .explanation-text small { color: #334155; display:block; margin-top:0.5rem; }
        .explanation-text mjx-container[display="false"] { padding: 0 0.2em; }
        mjx-container { vertical-align: middle; }
        strong { color: #0b5cff; }
        .bold-text { font-weight: bold; color: #0b5cff; }
    </style>
</head>
<body class="min-h-screen">
  <div id="app" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <!-- Header card -->
      <div class="bg-white rounded-t-2xl shadow-xl p-6 border-b-4 border-amber-400 relative">
        <div class="flex items-center gap-3 mb-2">
          <h1 class="text-3xl font-bold text-gray-900">CalcBot</h1> <!-- judul aplikasi -->
        </div>
        <p class="text-gray-600 text-sm">Hitung Limit, Turunan, dan Integral dengan SymPy dan penjelasan AI.</p> <!-- deskripsi singkat -->
        <a href="/graph"
          class="block md:absolute md:top-6 md:right-6 w-full md:w-auto mt-4 md:mt-0 px-4 py-3 md:px-4 md:py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg text-sm md:text-sm transition-colors shadow-md flex items-center justify-center md:justify-center gap-2">
          <i class="fa-solid fa-chart-area w-4 h-4"></i>
          <span class="ml-2">Graphing Calculator</span> <!-- tautan ke fitur grafik -->
        </a>
      </div>

      <!-- Tab header container (Limit / Turunan / Integral) -->
      <div class="bg-white shadow-lg flex border-b border-gray-200" id="tabs-container"></div>

      <!-- Form input dan tombol -->
      <div class="bg-white shadow-lg p-6 space-y-6 rounded-b-xl">
        <div id="quick-symbols" class="flex flex-wrap gap-2 p-2 bg-gray-50 rounded-xl border border-gray-200"></div> <!-- tombol simbol cepat -->

        <div>
          <label id="expression-label" class="block text-sm font-bold text-gray-700 mb-2">Fungsi f(x)</label> <!-- label input fungsi -->
          <input type="text" id="expression-input"
                placeholder="Contoh: 2x"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-500 focus:outline-none font-mono text-lg transition-all" /> <!-- input ekspresi -->
        </div>

        <div id="tab-specific-inputs"></div> <!-- tempat input khusus tiap tab -->

        <button id="calculate-button" class="w-full py-4 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-extrabold rounded-xl transition-all shadow-xl hover:shadow-2xl text-lg tracking-wider">
          Hitung Sekarang <!-- tombol untuk memicu perhitungan -->
        </button>
      </div>

      <div id="result-area" class="mt-6"></div> <!-- area hasil akan di-render di sini -->
    </div>
  </div>

<script>
/* ---------------- state ---------------- */
// objek state menyimpan status UI dan input pengguna
let state = {
  activeTab: 'limit', expression: '', variable: 'x', // tab aktif, ekspresi, variabel
  limitPoint: '1', limitDirection: 'both', // properti limit
  integralLower: '', integralUpper: '', // properti integral
  derivativeOrder: '1', loading:false, result:null // properti turunan, loading, hasil
};

// daftar simbol cepat untuk memudahkan input
const quickSymbols = [
  {label:'sin()', value:'sin('},{label:'cos()', value:'cos('},{label:'tan()', value:'tan('},
  {label:'ln()', value:'ln('},{label:'e^()', value:'e^('},{label:'sqrt()', value:'sqrt('},
  {label:'x**', value:'**'},{label:'π', value:'pi'},{label:'∞', value:'oo'}
];

// definisi tab aplikasi
const tabs = [
  {key:'limit', label:'Limit', fa:'fa-infinity'},
  {key:'derivative', label:'Turunan', fa:'fa-chart-line'},
  {key:'integral', label:'Integral', fa:'fa-chart-area'}
];

/* ---------------- helpers ---------------- */
// fungsi untuk escape HTML ketika menampilkan teks biasa
function escapeHtml(unsafe){
  if (unsafe == null) return '';
  return String(unsafe).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* Clean LaTeX text and fix escaped delimiters */
function cleanLatexText(text) {
  if (!text) return '';
  text = String(text);

  // Hapus wrapper JSON jika ada
  text = text.trim().replace(/^\{?\s*"?explanation_latex"?\s*:\s*/i, '');
  text = text.replace(/"\s*,\s*"key_formula_latex".*$/i, '');
  text = text.replace(/^\s*[\'\"]+|\s*[\'\"]+\s*$/g, '');
  
  // Perbaiki delimiter LaTeX yang ter-escape ganda
  text = text.replace(/\\\\\(/g, '\\\(');
  text = text.replace(/\\\\\)/g, '\\\)');
  text = text.replace(/\\\\\[/g, '\\\[');
  text = text.replace(/\\\\\]/g, '\\\]');
  
  // Perbaiki escape double untuk karakter khusus
  text = text.replace(/\\\\([{}_^])/g, '\\$1');
  
  // Tangani newline
  text = text.replace(/\\n\\n+/g, '<br><br>');
  text = text.replace(/\\n/g, '\n');
  
  // Hapus backslash ganda sebelum huruf
  text = text.replace(/\\{2,}([a-zA-Z])/g, '\\$1');

  return text;
}

/* Convert escaped LaTeX delimiters to proper MathJax format */
function fixLaTeXDelimiters(text) {
  if (!text) return '';
  
  // Konversi delimiters escaped ganda menjadi standar MathJax
  text = text.replace(/\\\\\(/g, '\\\(');
  text = text.replace(/\\\\\)/g, '\\\)');
  text = text.replace(/\\\\\[/g, '\\\[');
  text = text.replace(/\\\\\]/g, '\\\]');
  
  return text;
}

/* Convert markdown-style formatting to HTML */
function convertMarkdownToHTML(text) {
  if (!text) return '';
  
  // Ubah heading ## menjadi bold
  text = text.replace(/##\s*(.+?)(?=\n|$)/g, '<strong>$1</strong>');
  
  // Ubah **text** menjadi bold
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  
  return text;
}

// Panggil MathJax untuk merender LaTeX di elemen tertentu
function typesetMath(element) {
  if (window.MathJax && MathJax.typesetPromise) {
    MathJax.typesetPromise([element]).catch(err => console.error('MathJax typeset error:', err));
  }
}

/* ---------------- renderResult ---------------- */
function renderResult(){
  const container = document.getElementById('result-area'); // dapatkan container hasil
  container.innerHTML = '';
  const res = state.result; // ambil hasil dari state
  if (!res) return; // jika belum ada hasil, keluar

  const mainLatex = res.result_latex || res.result; // preferensi field result_latex
  const stepsLatex = res.steps_latex || res.steps || []; // ambil langkah solusi jika ada
  const explanationLatex = res.explanation_latex || res.explanation; // ambil penjelasan AI

  let stepsHtml = '';
  if (stepsLatex && stepsLatex.length > 0) {
    const stepItems = stepsLatex.map(step => `<li class="text-gray-700 text-base leading-relaxed latex-content">${step}</li>`).join('');
    stepsHtml = `
      <div class="bg-gray-50 rounded-xl p-6 mb-4 border border-gray-200">
        <h3 class="font-bold text-gray-800 mb-4 text-xl border-b pb-2 border-amber-300 flex items-center gap-2">
          <i class="fa-solid fa-list-ol text-amber-600"></i> Langkah-langkah Solusi (SymPy)
        </h3>
        <ol class="space-y-4 list-decimal pl-5">${stepItems}</ol>
      </div>
    `; // HTML daftar langkah
  }

  // Bersihkan dan perbaiki LaTeX pada penjelasan
  let cleanedExplanation = '';
  if (explanationLatex) {
    cleanedExplanation = cleanLatexText(explanationLatex);
    cleanedExplanation = fixLaTeXDelimiters(cleanedExplanation);
    cleanedExplanation = convertMarkdownToHTML(cleanedExplanation);
    
    // Split menjadi paragraf dan bungkus <p>
    const paragraphs = cleanedExplanation.split(/<br><br>|\n\n/).map(p => p.trim()).filter(p => p.length > 0);
    cleanedExplanation = paragraphs.map(p => `<p>${p}</p>`).join('');
  }

  const explanationHtml = cleanedExplanation ? `
    <div id="explanation-block" class="bg-blue-50 rounded-xl p-6 border border-blue-300 shadow-inner">
      <h3 class="font-bold text-blue-800 mb-3 text-lg flex items-center gap-2"><i class="fa-solid fa-brain"></i> Penjelasan (Gemini AI)</h3>
      <div class="explanation-text latex-content text-gray-800" style="line-height: 2;">
        ${cleanedExplanation}
      </div>
    </div>
  ` : '';

  // HTML utama untuk menampilkan hasil akhir
  const mainHtml = `
    <div class="bg-white rounded-b-2xl shadow-xl p-6 border-t-4 border-orange-400">
      <div class="bg-gradient-to-r from-amber-100 to-orange-100 rounded-xl p-6 mb-6 border-4 border-amber-400">
        <p class="text-sm text-gray-600 mb-3 font-semibold uppercase tracking-wide flex items-center gap-2"><i class="fa-solid fa-trophy text-amber-600"></i> HASIL AKHIR</p>
        <div class="text-3xl font-bold text-gray-900 latex-content">
          ${mainLatex ? `\\[ ${mainLatex} \\]` : escapeHtml(res.result || "Tidak ada hasil")}
        </div>
      </div>
      ${stepsHtml}
      ${explanationHtml}
    </div>
  `;

  container.innerHTML = mainHtml; // masukkan HTML hasil ke container
  
  // Render MathJax setelah DOM siap
  setTimeout(() => {
    typesetMath(container);
  }, 100);
}

/* ---------------- UI helpers ---------------- */
function renderQuickSymbols(){
  const container = document.getElementById('quick-symbols'); // container simbol cepat
  container.innerHTML = quickSymbols.map(sym=>`
    <button data-value="${sym.value}" class="px-3 py-2 bg-amber-100 text-amber-800 hover:bg-amber-200 rounded-lg text-sm font-semibold transition-colors shadow-sm symbol-btn">
      ${sym.label}
    </button>
  `).join('');

  // Pasang event listener untuk setiap tombol simbol
  document.querySelectorAll('.symbol-btn').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      const v = e.currentTarget.getAttribute('data-value');
      const input = document.getElementById('expression-input');
      setTimeout(()=> {
        input.focus();
        const s = input.selectionStart, epos = input.selectionEnd;
        const full = input.value;
        input.value = full.substring(0,s) + v + full.substring(epos); // sisipkan simbol
        input.selectionStart = input.selectionEnd = s + v.length; // atur posisi kursor
        state.expression = input.value; // update state ekspresi
        renderButton(); // update tombol (enable/disable)
      },0);
    });
  });
}

function renderTabs(){
  const container = document.getElementById('tabs-container'); // container tab
  container.innerHTML = tabs.map(tab=>`
    <button data-tab="${tab.key}" class="flex-1 py-4 px-3 md:px-6 font-bold transition-all flex items-center justify-center gap-2 text-sm md:text-base tab-btn
      ${state.activeTab===tab.key ? 'bg-amber-100 text-amber-800 border-b-4 border-amber-600' : 'text-gray-600 hover:bg-gray-50'}">
      <i class="fa-solid ${tab.fa} w-4 h-4 md:w-5 md:h-5"></i>
      <span class="hidden md:inline">${tab.label}</span>
      <span class="md:hidden text-sm">${tab.label}</span>
    </button>
  `).join('');

  // Pasang event listener untuk pergantian tab
  document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click', (e)=>{
    const k = e.currentTarget.getAttribute('data-tab');
    if (state.activeTab !== k) { state.activeTab = k; renderUI(); } // ubah tab dan re-render UI
  }));
}

function renderTabInputs(){
  const container = document.getElementById('tab-specific-inputs'); // container untuk input spesifik tab
  const inputGroup = (id,label,value,placeholder)=>`
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">${label}</label>
      <input id="${id}" type="text" value="${value}" placeholder="${placeholder}"
             class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none bg-white transition-all input-control"/>
    </div>
  `;
  let html = '';
  if (state.activeTab === 'limit') {
    html = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-amber-50 p-4 rounded-xl border border-amber-200 tab-content">
      ${inputGroup('variable-input','Variabel',state.variable,'x')}
      ${inputGroup('limit-point-input','Menuju Nilai (a)',state.limitPoint,'1, 0, oo, -oo')}
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Arah Limit</label>
      <select id="limit-direction-select" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none bg-white transition-all select-control">
        <option value="both" ${state.limitDirection==='both'?'selected':''}>Dua Arah (a)</option>
        <option value="left" ${state.limitDirection==='left'?'selected':''}>Kiri (a⁻)</option>
        <option value="right" ${state.limitDirection==='right'?'selected':''}>Kanan (a⁺)</option>
      </select></div>
    </div>`;
  } else if (state.activeTab === 'derivative') {
    html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-amber-50 p-4 rounded-xl border border-amber-200 tab-content">
      ${inputGroup('variable-input','Variabel',state.variable,'x')}
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">Orde Turunan</label>
      <select id="derivative-order-select" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-amber-500 focus:outline-none bg-white transition-all select-control">
        <option value="1" ${state.derivativeOrder==='1'?'selected':''}>Pertama (f')</option>
        <option value="2" ${state.derivativeOrder==='2'?'selected':''}>Kedua (f'')</option>
        <option value="3" ${state.derivativeOrder==='3'?'selected':''}>Ketiga (f''')</option>
      </select></div>
    </div>`;
  } else {
    html = `<div class="space-y-4 tab-content">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-amber-50 p-4 rounded-xl border border-amber-200">
        ${inputGroup('variable-input','Variabel',state.variable,'x')}
      </div>
      <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
        <label class="flex items-center gap-2 text-sm font-bold text-gray-700 mb-3"><i class="fa-solid fa-circle-info text-blue-600"></i>Batas Integral Tentu (Opsional)</label>
        <div class="grid grid-cols-2 gap-4">
          ${inputGroup('integral-lower-input','Batas Bawah (a)',state.integralLower,'Kosongkan untuk tak tentu')}
          ${inputGroup('integral-upper-input','Batas Atas (b)',state.integralUpper,'Kosongkan untuk tak tentu')}
        </div>
      </div>
    </div>`;
  }
  container.innerHTML = html; // render input tab ke DOM
  attachInputListeners(); // pasang listener pada input yang baru dibuat
}

function attachInputListeners(){
  const add = (id, prop) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', (e)=>{ state[prop] = e.target.value; if (prop==='variable') document.getElementById('expression-label').textContent = `Fungsi f(${state.variable})`; renderButton(); });
  };
  add('variable-input','variable');
  if (state.activeTab === 'limit') {
    add('limit-point-input','limitPoint');
    document.getElementById('limit-direction-select')?.addEventListener('change',(e)=>{ state.limitDirection = e.target.value; renderButton(); });
  } else if (state.activeTab === 'derivative') {
    document.getElementById('derivative-order-select')?.addEventListener('change',(e)=>{ state.derivativeOrder = e.target.value; renderButton(); });
  } else {
    add('integral-lower-input','integralLower'); add('integral-upper-input','integralUpper');
  }
}

function renderButton(){
  const btn = document.getElementById('calculate-button'); // tombol hitung
  const disabled = !state.expression || state.loading; // disable jika tidak ada ekspresi atau sedang loading
  btn.disabled = disabled;
  if (state.loading) btn.innerHTML = `<span class="flex items-center justify-center gap-2"><span class="loading-animation w-5 h-5 border-2 border-white"></span> Menghitung...</span>`; // tampilkan animasi saat loading
  else btn.innerHTML = 'Hitung Sekarang';
  if (disabled) btn.classList.add('disabled:from-gray-300','disabled:to-gray-400','disabled:cursor-not-allowed');
  else btn.classList.remove('disabled:from-gray-300','disabled:to-gray-400','disabled:cursor-not-allowed');
}

function renderUI(){ renderTabs(); renderTabInputs(); renderButton(); renderResult(); } // render penuh UI

function sanitizeInputForSympy(expression){
  if (!expression) return '';
  let s = expression;
  s = s.replace(/\^/g,'**'); // ubah ^ menjadi ** untuk Python/SymPy
  s = s.replace(/([0-9.])([a-zA-Z(])/g,'$1*$2'); // tambahkan '*' antara angka dan variabel
  s = s.replace(/([a-zA-Z)])(\()/g,'$1*$2'); // tambahkan '*' sebelum '('
  s = s.replace(/(\))([a-zA-Z0-9])/g,'$1*$2');
  s = s.replace(/([a-zA-Z])([a-zA-Z])/g,'$1*$2');
  return s;
}

/* ---------- API ---------- */
async function calculate(){
  if (!state.expression) return; // jika tidak ada ekspresi, batalkan
  state.loading = true; state.result = null; renderButton(); renderResult(); // set loading dan render
  const sanitized = sanitizeInputForSympy(state.expression); // sanitasi ekspresi
  const payload = {
    expression: sanitized, operation: state.activeTab, variable: state.variable,
    limit_point: state.limitPoint, limit_direction: state.limitDirection,
    derivative_order: state.derivativeOrder, integral_lower: state.integralLower, integral_upper: state.integralUpper
  };
  try {
    const resp = await fetch('/api/compute', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    }); // kirim request ke backend
    const data = await resp.json();
    if (resp.ok) {
      state.result = data; // simpan hasil
    } else {
      state.result = { error: `Backend Error: ${data.error || 'Terjadi kesalahan server.'}` };
    }
  } catch (err) {
    console.error('Fetch failed:', err);
    state.result = { error: 'Terjadi kesalahan jaringan. Pastikan server Flask berjalan.' };
  }
  state.loading = false; renderButton(); renderResult(); // update state loading dan render lagi
}

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  renderQuickSymbols(); // render tombol simbol
  document.getElementById('expression-input').value = state.expression; // set nilai awal input
  document.getElementById('expression-input').addEventListener('input', (e)=>{ state.expression = e.target.value; renderButton(); }); // sync input ke state
  document.getElementById('calculate-button').addEventListener('click', calculate); // pasang handler klik
  renderUI(); // render UI pertama kali
});
</script>
</body>
</html>
